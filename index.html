<!doctype html>
<meta charset="utf-8">
<title>Uwilno's Blog</title>
<script>
  const MIRRORS = [
    // 推荐把“最可能直连成功”的放前面
    "https://ipv6.uwillno.com:9102",
    "https://cloudflare.uwillno.com",
    "https://edgeone.uwillno.com",
    "https://vercel.uwillno.com",
    "https://github.uwillno.com",
    "https://netlify.uwillno.com",
    "https://azure.uwillno.com",
    "https://tunnel.uwillno.com"
  ];

  // 参数：为大陆网络定的
  const PROBE_PATH = "/blog01.wasm";
  const RANGE = "bytes=0-32767"; // 32KB
  const TIMEOUT = 900;           // ms
  const CONCURRENCY = 3;

  let jumped = false;
  const ctrls = [];

  function probe(base) {
    const ctrl = new AbortController();
    ctrls.push(ctrl);

    const timer = setTimeout(() => ctrl.abort(), TIMEOUT);

    return fetch(base + PROBE_PATH + "?_=" + Math.random(), {
      method: "GET",
      cache: "no-store",
      headers: {
        Range: RANGE,
        Accept: "*/*"
      },
      signal: ctrl.signal
    }).then(r => {
      clearTimeout(timer);
      // 206 = 正常 Range，200 = 某些 CDN 不支持 Range
      if (r.status === 206 || r.status === 200) {
        return base;
      }
      return Promise.reject();
    });
  }

  // 只并发前 N 个，避免大陆网络互相拖死
  Promise.any(
    MIRRORS.slice(0, CONCURRENCY).map(probe)
  ).then(hit => {
    if (jumped) return;
    jumped = true;

    // 立刻掐掉其他请求
    ctrls.forEach(c => c.abort());

    location.replace(hit + location.search);
  }).catch(() => {
    // 全灭：给一个确定的兜底（让用户自己开代理）
    location.replace(MIRRORS[0] + location.search);
  });
</script>